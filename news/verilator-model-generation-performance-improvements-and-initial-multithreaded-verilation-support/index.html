<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=5">
<link href=/vendor/bootstrap/bootstrap.min.css rel=stylesheet>
<link href=/vendor/phosphor-icons/css/phosphor.css rel=stylesheet>
<link href=/vendor/magnific-popup/magnific-popup.css rel=stylesheet>
<link rel=stylesheet href=/scss/theme.min.a5381c44cba9afddcecb1f5a7770e438e042e9a03f795caa7ee5af578c5025b5.css>
<link rel=icon href=/images/favicon/cropped-favicon-1-32x32.png sizes=32x32>
<link rel=icon href=/images/favicon/cropped-favicon-1-192x192.png sizes=192x192>
<link rel=apple-touch-icon href=/images/favicon/cropped-favicon-1-180x180.png>
<meta name=msapplication-TileImage content="/images/favicon/cropped-favicon-1-270x270.png">
<script src=https://cmp.osano.com/16A0DbT9yDNIaQkvZ/3b49aaa9-15ab-4d47-a8fb-96cc25b5543c/osano.js></script>
<title>Verilator Model Generation Performance Improvements and Initial Multithreaded Verilation Support | CHIPS Alliance</title>
<meta name=description content="Verilator can boast the status of one of the most widely used free and open source digital design tools for ASIC and FPGA development. To stay on top …">
<meta property="og:title" content="Verilator Model Generation Performance Improvements and Initial Multithreaded Verilation Support">
<meta property="og:description" content="Verilator can boast the status of one of the most widely used free and open source digital design tools for ASIC and FPGA development. To stay on top of the ever-increasing complexity of ASIC and FPGA devices, as users and contributors, Antmicro, a CHIPS Alliance member and part of the Tools Workgroup, has been actively working on improving the tool and its ecosystem, including adding co-simulation capabilities with Renode, adding support for SystemVerilog UVM testbenches to Verilator, or improving scalability for very large designs.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://chipsalliance.org/news/verilator-model-generation-performance-improvements-and-initial-multithreaded-verilation-support/"><meta property="og:image" content="https://chipsalliance.org/news/verilator-model-generation-performance-improvements-and-initial-multithreaded-verilation-support/Accelerating-model-generation-in-Verilator--blog-CHIPS.svg"><meta property="article:section" content="news">
<meta property="article:published_time" content="2023-09-29T00:00:00+00:00">
<meta property="article:modified_time" content="2023-09-29T00:00:00+00:00"><meta property="og:site_name" content="CHIPS Alliance">
<meta itemprop=name content="Verilator Model Generation Performance Improvements and Initial Multithreaded Verilation Support">
<meta itemprop=description content="Verilator can boast the status of one of the most widely used free and open source digital design tools for ASIC and FPGA development. To stay on top of the ever-increasing complexity of ASIC and FPGA devices, as users and contributors, Antmicro, a CHIPS Alliance member and part of the Tools Workgroup, has been actively working on improving the tool and its ecosystem, including adding co-simulation capabilities with Renode, adding support for SystemVerilog UVM testbenches to Verilator, or improving scalability for very large designs."><meta itemprop=datePublished content="2023-09-29T00:00:00+00:00">
<meta itemprop=dateModified content="2023-09-29T00:00:00+00:00">
<meta itemprop=wordCount content="1102"><meta itemprop=image content="https://chipsalliance.org/news/verilator-model-generation-performance-improvements-and-initial-multithreaded-verilation-support/Accelerating-model-generation-in-Verilator--blog-CHIPS.svg">
<meta itemprop=keywords content><meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://chipsalliance.org/news/verilator-model-generation-performance-improvements-and-initial-multithreaded-verilation-support/Accelerating-model-generation-in-Verilator--blog-CHIPS.svg">
<meta name=twitter:title content="Verilator Model Generation Performance Improvements and Initial Multithreaded Verilation Support">
<meta name=twitter:description content="Verilator can boast the status of one of the most widely used free and open source digital design tools for ASIC and FPGA development. To stay on top of the ever-increasing complexity of ASIC and FPGA devices, as users and contributors, Antmicro, a CHIPS Alliance member and part of the Tools Workgroup, has been actively working on improving the tool and its ecosystem, including adding co-simulation capabilities with Renode, adding support for SystemVerilog UVM testbenches to Verilator, or improving scalability for very large designs.">
<meta name=twitter:site content="@chipsalliance">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-H0KF2YZTR7"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-H0KF2YZTR7')</script>
</head>
<body>
<header>
<div class="lfprojects position-fixed">
<a href=https://www.linuxfoundation.org/projects target=_blank rel="noopener noreferrer"><img src=/images/lf-projects-banner-white.svg></a>
</div>
<nav class="navbar navbar-expand-lg position-fixed w-100 zindex-dropdown" id=mainnavigationBar>
<a class=navbar-brand href=/>
<img src=/images/chips_alliance.svg alt=Nav-Logo>
</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-default><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><line x1="3.5" y1="5.5" x2="21.5" y2="5.5" stroke="#292d32" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/><line x1="4.5" y1="12.5" x2="21.5" y2="12.5" stroke="#292d32" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.5" y1="19.5" x2="21.5" y2="19.5" stroke="#292d32" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
</span>
<span class=navbar-toggler-toggled><svg width="20" height="20" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21.5 6.5l-15 15" stroke="#404152" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/><path d="M21.5 21.5l-15-15" stroke="#404152" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
</span>
</button>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mx-auto mb-20 mb-lg-0 navbar-nav-scroll">
<li class="nav-item dropdown">
<div class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true aria-expanded=false>
About
</div>
<div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink>
<a class=dropdown-item href=/about/who-we-are/>Who We Are</a>
<a class=dropdown-item href=/about/members/>Members</a>
<a class=dropdown-item href=/about/governance/>Governance</a>
<a class=dropdown-item href=/about/faq/>FAQ</a>
<a class=dropdown-item href=/about/contact/>Contact</a>
</div>
</li>
<li class=nav-item>
<a class=nav-link href=/projects/>
Projects
</a>
</li>
<li class=nav-item>
<a class=nav-link href=/events/>
Events
</a>
</li>
<li class=nav-item>
<a class=nav-link href=/workgroups/>
Workgroups
</a>
</li>
<li class="nav-item dropdown">
<div class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true aria-expanded=false>
News
</div>
<div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink>
<a class=dropdown-item href=/categories/announcements/>Announcements</a>
<a class=dropdown-item href=/categories/blog/>Blog</a>
<a class=dropdown-item href=/categories/reports/>Reports</a>
</div>
</li>
<li class=nav-item>
<a class=nav-link href=/join/>
Join
</a>
</li>
</ul>
</div>
<div class="d-none d-lg-block">
<div class=nav-item>
<a href=/getting-started/ class="btn btn-sm btn-primary">Get Started</a>
</div>
</div>
</nav>
</header>
<section class=blog-details>
<div class=container>
<div class=row>
<div class=col-lg-12>
<article class=blog-single>
<div class=inner-blog-details>
<h1>Verilator Model Generation Performance Improvements and Initial Multithreaded Verilation Support</h1>
<div class=inner-blog-details-meta>
<ul class=list-unstyled>
<li class=list-inline-item>
<p>September 29, 2023</p>
</li>
<li class=list-inline-item>
<p>6 <span>minutes</span></p>
</li>
<li class=list-inline-item>
<p>1102 <span>words</span></p>
</li>
</ul>
</div>
</div>
<div class="rounded-box mb-xxl-11 mb-8">
<img src=https://chipsalliance.org/news/verilator-model-generation-performance-improvements-and-initial-multithreaded-verilation-support/Accelerating-model-generation-in-Verilator--blog-CHIPS.svg class=w-100 alt=featured-image>
</div>
<div><p>Verilator can boast the status of one of the most widely used free and open source digital design tools for ASIC and FPGA development. To stay on top of the ever-increasing complexity of ASIC and FPGA devices, as users and contributors, Antmicro, a CHIPS Alliance member and part of the <a href=https://lists.chipsalliance.org/g/tools-wg>Tools Workgroup</a>, has been actively working on improving the tool and its ecosystem, <a href=https://antmicro.com/blog/2023/01/cpu-rtl-co-simulation-in-renode/>including adding co-simulation capabilities with Renode</a>, <a href=https://antmicro.com/blog/2023/01/open-source-systemverilog-uvm-support-in-verilator/>adding support for SystemVerilog UVM testbenches to Verilator</a>, or <a href=https://antmicro.com/blog/2022/11/scaling-verilator-for-very-large-designs/>improving scalability for very large designs</a>.</p>
<p>Even though Verilator is most likely already the fastest open source Verilog/SystemVerilog simulator out there, generating and compiling simulation models for large designs can still be very time-consuming. This note presents the improvements Antmicro has introduced to model generation (aka verilation) in terms of memory usage and execution time optimizations, as well as an ongoing effort aimed at parallelizing Verilator passes by enabling multithreading in the verilation process.</p>
<h3 id=execution-time-and-memory-usage-improvements>Execution time and memory usage improvements</h3>
<p>In the recent months, Antmicro added multiple assorted optimizations across Verilator’s codebase that reduced execution times and memory usage for model generation which we list below along with tables containing data presenting the improvements brought on by each of them.</p>
<ul>
<li>The <code>m_name</code> field was removed from <code>AstVarRef</code> (“variable reference”), one of the most commonly recurring AST nodes. Now it references a variable’s name directly, since the name in <code>AstVarRef</code>’ was always identical to it, making the field redundant. Dropping this single field allowed the Antmicro team to reduce memory usage by 8-12% and reduce verilation time by 4-5% for the test designs:</li>
</ul>
<p><img src=Accelerating-model-generation-in-Verilator--blog-tabel-1.svg alt="Performance comparison 1"></p>
<ul>
<li>Antmicro introduced a custom runtime type information solution instead of C++’s <code>dynamic_cast</code> for checking graph types. This type info is used for downcasting generic graph vertices/edges to concrete types. Similarly to what was already done for the AST and data-flow graphs. It shows a significant performance boost over <code>dynamic_cast</code>. On top of this change, for graph vertices or edges where the desired downcast type is obvious, they have removed typechecks, resulting in further performance improvements for our test designs:</li>
</ul>
<p><img src=Accelerating-model-generation-in-Verilator--blog-tabel-1_1.svg alt="Performance comparison 2"></p>
<ul>
<li>Another improvement was to rework the <code>m_selfPointer</code> field in <code>AstVarRef</code> and <code>AstCCall</code> (C/C++ function call). This field contains a string that needs to be put before a given variable reference or function call, and represents a reference to a “self” object, such as <code>this</code>. Each instance of these nodes contained a copy of such a “self pointer” string. After this change, these strings are shared across multiple instances of these nodes. Apart from bringing slight memory usage and performance benefits, it cleans up the code a bit by limiting the number of ad-hoc string operations:</li>
</ul>
<p><img src=Accelerating-model-generation-in-Verilator--blog-tabel-3.svg alt="Performance comparison 3"></p>
<ul>
<li>Antmicro also replaced the costly <code>VN_AS</code> typecast in child node getters with C++’s <code>reinterpret_cast</code> in release builds (this remains unchanged for debug builds for error checking purposes). The type assertion is unnecessary in this particular case, as most of the time the pointers can only be set through properly typed setters. This resulted in 4-5% time improvements for the test designs:</li>
</ul>
<p><img src=Accelerating-model-generation-in-Verilator--blog-tabel-4.svg alt="Performance comparison 4"></p>
<h3 id=path-towards-multithreaded-verilation>Path towards multithreaded verilation</h3>
<p>While all the changes listed above offer tangible speed and memory usage improvements to the model generation process, the most significant potential for gains lies in introducing multithreading to the currently single-threaded process. Model generation in Verilator consists of multiple stages that mutate a Verilog/SystemVerilog Abstract Syntax Tree (AST) that represents the simulated design and then outputs the model as C++ code, ready to be compiled. The branches of the AST that are independent of each other can, in theory, be processed in-parallel but since Verilator is a very extensive project, introducing multithreading to the entirety of the verilation process at once is not feasible, the team is set on introducing the changes incrementally.</p>
<p>As far as Verilator’s functions go, they can be divided into thread-safe and non thread-safe. Each function needs to be thoroughly investigated and appropriately marked by hand, which may lead to human errors detrimental to the overall functioning of the tool. To make sure thread-safe functions only call other thread-safe functions, Antmicro <a href=https://github.com/verilator/verilator/pull/3748>introduced a CI check</a> that uses clang annotations and verifies this assumption.</p>
<p>As spawning threads is a relatively slow process, and controlling the number of threads is crucial in this scenario, Antmicro <a href=https://github.com/verilator/verilator/pull/3898>introduced a thread pool</a> that accepts jobs and queues them up for execution, so that the CPU doesn’t context switch between them unnecessarily, leading to performance loss.</p>
<p>Since multithreaded programming is complex and sometimes unstable (especially at the development phase), it was crucial that we made sure single threaded verilation is unaffected. To ensure there is no time increase or deadlock while generating models using a single thread, the team <a href=https://github.com/verilator/verilator/pull/4048>introduced a switch</a> that can disable thread synchronization if not needed.</p>
<p><a href=https://github.com/verilator/verilator/pull/3680>Error reporting also needed refactoring</a> to make it thread-safe. It is responsible for error reporting, is used in every part of Verilator and can be called recursively. This change reduced total C++ emit time in our large-core based test design from 144 s to 80 s. Error reporting makes for an interesting example of the type of obstacles one meets when refactoring code to be thread-safe, as reporting cannot be parallelized since it can only have one output to which we need to print in-order (e.g. the terminal).</p>
<p>With the changes listed above already part of mainline Verilator, we can now proceed to focus on the next steps towards making multithreaded verilation reality. Antmicro has identified numerous other areas we need to optimize for full parallelization, e.g. the ability to disable multithreading locally so that thread-safe functions can be called only when they are necessary, or analysis and adjustment of subsequent passes for multithreading optimization purposes. CHIPS will be reporting on this progress in future blog posts.</p>
<h3 id=integrate-verilator-into-your-projects-workflow-with-chips>Integrate Verilator into your project’s workflow with CHIPS</h3>
<p>While the efforts within the CHIPS Alliance to enable multithreading across Verilator along with other improvements are ongoing, Antmicro can help you adopt, adapt, and extend Verilator to integrate it into a workflow tailored to your particular project, including scaling it for very large designs and co-simulation of entire systems with the open source <a href=https://renode.io>Renode</a> simulation framework.</p>
<p>To learn more about the Tools Workgroup’s contributions to Verilator, you can watch a talk by Antmicro from <a href=https://orconf.org/>ORConf 2023</a> in which they discuss the current status of non-synthesizable SystemVerilog support in the Verilator open source simulator and progress toward full UVM support.</p>
<p>With years of experience in commercial and R&D FPGA and ASIC-based projects, as well as leading theCHIPS Alliance’s Tools Workgroup, Antmicro offers comprehensive engineering support that can help you make the most of the flexibility and approachability of open source solutions. Do not hesitate to reach out at <a href=mailto:contact@antmicro.com>contact@antmicro.com</a>.</p>
</div>
</article>
</div>
</div>
</div>
</section>
<section class="blog-related position-relative">
<div class=container>
<div class=row>
<div class=col-md-12>
<div class=blog-section>
<h2 class=blog-section-title>Recent News</h2>
</div>
</div>
</div>
<div class=row>
<div class="col-lg-4 col-md-6">
<article class=blog-post>
<div class=blog-post-thumb>
<a href=/news/caliptra-ocp-global-summit-2024/>
<img src=https://chipsalliance.org/news/caliptra-ocp-global-summit-2024/caliptra-logo-2.png alt=blog-thumb loading=lazy>
</a>
</div>
<div class=blog-post-content>
<div class=blog-post-tag>
<a href=https://chipsalliance.org/categories/blog>Blog</a>
</div>
<div class=blog-post-date>
October 13, 2024
</div>
<div class=blog-post-title>
<a href=/news/caliptra-ocp-global-summit-2024/>Caliptra @ OCP Global Summit 2024</a>
</div>
</div>
</article>
</div>
<div class="col-lg-4 col-md-6">
<article class=blog-post>
<div class=blog-post-thumb>
<a href=/news/initial-assertion-control-support-in-verilator/>
<img src=https://chipsalliance.org/news/initial-assertion-control-support-in-verilator/verilator-assertcontrol-chipsalliance-blog.png alt=blog-thumb loading=lazy>
</a>
</div>
<div class=blog-post-content>
<div class=blog-post-tag>
<a href=https://chipsalliance.org/categories/blog>Blog</a>
</div>
<div class=blog-post-date>
June 21, 2024
</div>
<div class=blog-post-title>
<a href=/news/initial-assertion-control-support-in-verilator/>Initial assertion control support in Verilator</a>
</div>
</div>
</article>
</div>
<div class="col-lg-4 col-md-6">
<article class=blog-post>
<div class=blog-post-thumb>
<a href=/news/speeding-up-openroad-for-fast-design-feedback/>
<img src=https://chipsalliance.org/news/speeding-up-openroad-for-fast-design-feedback/Speeding-up-OpenROAD-optimizations-blog-1.png alt=blog-thumb loading=lazy>
</a>
</div>
<div class=blog-post-content>
<div class=blog-post-tag>
<a href=https://chipsalliance.org/categories/blog>Blog</a>
</div>
<div class=blog-post-date>
May 24, 2024
</div>
<div class=blog-post-title>
<a href=/news/speeding-up-openroad-for-fast-design-feedback/>Speeding Up OpenROAD For Fast Design Feedback</a>
</div>
</div>
</article>
</div>
</div>
</div>
</section>
<footer class="footer pt-xxl-19 pt-8 pb-sm-7 pb-5" id=footer>
<div class=container-fluid>
<div class=footer-wrapper>
<div class=row>
<div class="col-12 col-lg-4 me-auto order-2 order-lg-1">
<div class="footer-logo mt-7 mt-md-0 mb-5">
<a href=/>
<img src=/images/chips-logo-white.svg alt=logo>
</a>
</div>
<div class=social-icon>
<ul class=list-unstyled>
<li>
<a href=https://twitter.com/chipsalliance> <i class=ph-twitter-logo></i> </a>
</li>
<li>
<a href=https://github.com/chipsalliance> <i class=ph-github-logo></i> </a>
</li>
<li>
<a href=https://www.linkedin.com/company/chipsalliance/> <i class=ph-linkedin-logo></i> </a>
</li>
</ul>
</div>
<div class="footer-logo mt-7 mt-md-0">
<p>
© Copyright <span>2024</span> CHIPS Alliance
The Linux Foundation® . All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href=https://www.linuxfoundation.org/trademark-usage>Trademark Usage</a> page. Linux is a registered trademark of Linus Torvalds. <a href=http://www.linuxfoundation.org/privacy>Privacy Policy</a> and <a href=http://www.linuxfoundation.org/terms>Terms of Use</a>.
</p>
</div>
</div>
<div class="col-6 col-md-4 col-sm-4 col-lg-2 order-1">
<div class=footer-widget>
<h3>About</h3>
<ul class=list-unstyled>
<li>
<a href=/about/who-we-are/>Who We Are</a>
</li>
<li>
<a href=/about/members/>Members</a>
</li>
<li>
<a href=https://members.chipsalliance.org/>Member Support</a>
</li>
<li>
<a href=/about/governance/>Governance</a>
</li>
<li>
<a href=/about/faq/>FAQ</a>
</li>
<li>
<a href=/about/contact/>Contact</a>
</li>
</ul>
</div>
</div>
<div class="col-6 col-md-4 col-sm-4 col-lg-2 order-1">
<div class=footer-widget>
<h3>Community</h3>
<ul class=list-unstyled>
<li>
<a href=/projects/>Projects</a>
</li>
<li>
<a href=/getting-started/>Getting Started</a>
</li>
<li>
<a href=/events/>Events</a>
</li>
<li>
<a href=/workgroups/>Workgroups</a>
</li>
</ul>
</div>
</div>
<div class="col-6 col-md-4 col-sm-4 col-lg-2 order-1">
<div class=footer-widget>
<h3>News</h3>
<ul class=list-unstyled>
<li>
<a href=/categories/announcements/>Announcements</a>
</li>
<li>
<a href=/categories/blog/>Blog</a>
</li>
<li>
<a href=/categories/reports/>Reports</a>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</footer>
<script src=/vendor/jQuery/jquery.min.js></script>
<script src=/vendor/bootstrap/bootstrap.bundle.min.js></script>
<script src=/vendor/counter-up/countup.js></script>
<script src=/vendor/magnific-popup/magnific-popup.min.js></script>
<script src=/js/script.js></script>
</body>
</html>