<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=5">
<link href=/vendor/bootstrap/bootstrap.min.css rel=stylesheet>
<link href=/vendor/phosphor-icons/css/phosphor.css rel=stylesheet>
<link href=/vendor/magnific-popup/magnific-popup.css rel=stylesheet>
<link rel=stylesheet href=/scss/theme.min.a5381c44cba9afddcecb1f5a7770e438e042e9a03f795caa7ee5af578c5025b5.css>
<link rel=icon href=/images/favicon/cropped-favicon-1-32x32.png sizes=32x32>
<link rel=icon href=/images/favicon/cropped-favicon-1-192x192.png sizes=192x192>
<link rel=apple-touch-icon href=/images/favicon/cropped-favicon-1-180x180.png>
<meta name=msapplication-TileImage content="/images/favicon/cropped-favicon-1-270x270.png">
<script src=https://cmp.osano.com/16A0DbT9yDNIaQkvZ/3b49aaa9-15ab-4d47-a8fb-96cc25b5543c/osano.js></script>
<title>Open Source USB test suite | CHIPS Alliance</title>
<meta name=description content="Note: the open source test suite will be demonstrated at the CHIPS Alliance booth at the RISC-V Summit 2019 – join us Dec 10-12 in the San Jose …">
<meta property="og:title" content="Open Source USB test suite">
<meta property="og:description" content="Note: the open source test suite will be demonstrated at the CHIPS Alliance booth at the RISC-V Summit 2019 – join us Dec 10-12 in the San Jose Convention Center!
USB is often a daunting topic for developers, and implementing support for it from scratch is a time consuming task. When the expected result is more complicated than a USB-to-serial bridge, the solution would be to either use a hardware transceiver or, especially for older USB standards, use an open source core to implement one directly in the FPGA fabric.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://chipsalliance.org/news/open-source-usb-test-suite/"><meta property="og:image" content="https://chipsalliance.org/images/blog-share.jpg"><meta property="article:section" content="news">
<meta property="article:published_time" content="2019-12-06T00:00:00+00:00">
<meta property="article:modified_time" content="2019-12-06T00:00:00+00:00"><meta property="og:site_name" content="CHIPS Alliance">
<meta itemprop=name content="Open Source USB test suite">
<meta itemprop=description content="Note: the open source test suite will be demonstrated at the CHIPS Alliance booth at the RISC-V Summit 2019 – join us Dec 10-12 in the San Jose Convention Center!
USB is often a daunting topic for developers, and implementing support for it from scratch is a time consuming task. When the expected result is more complicated than a USB-to-serial bridge, the solution would be to either use a hardware transceiver or, especially for older USB standards, use an open source core to implement one directly in the FPGA fabric."><meta itemprop=datePublished content="2019-12-06T00:00:00+00:00">
<meta itemprop=dateModified content="2019-12-06T00:00:00+00:00">
<meta itemprop=wordCount content="873"><meta itemprop=image content="https://chipsalliance.org/images/blog-share.jpg">
<meta itemprop=keywords content><meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://chipsalliance.org/images/blog-share.jpg">
<meta name=twitter:title content="Open Source USB test suite">
<meta name=twitter:description content="Note: the open source test suite will be demonstrated at the CHIPS Alliance booth at the RISC-V Summit 2019 – join us Dec 10-12 in the San Jose Convention Center!
USB is often a daunting topic for developers, and implementing support for it from scratch is a time consuming task. When the expected result is more complicated than a USB-to-serial bridge, the solution would be to either use a hardware transceiver or, especially for older USB standards, use an open source core to implement one directly in the FPGA fabric.">
<meta name=twitter:site content="@chipsalliance">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-H0KF2YZTR7"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-H0KF2YZTR7')</script>
</head>
<body>
<header>
<div class="lfprojects position-fixed">
<a href=https://www.linuxfoundation.org/projects target=_blank rel="noopener noreferrer"><img src=/images/lf-projects-banner-white.svg></a>
</div>
<nav class="navbar navbar-expand-lg position-fixed w-100 zindex-dropdown" id=mainnavigationBar>
<a class=navbar-brand href=/>
<img src=/images/chips_alliance.svg alt=Nav-Logo>
</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-default><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><line x1="3.5" y1="5.5" x2="21.5" y2="5.5" stroke="#292d32" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/><line x1="4.5" y1="12.5" x2="21.5" y2="12.5" stroke="#292d32" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.5" y1="19.5" x2="21.5" y2="19.5" stroke="#292d32" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
</span>
<span class=navbar-toggler-toggled><svg width="20" height="20" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21.5 6.5l-15 15" stroke="#404152" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/><path d="M21.5 21.5l-15-15" stroke="#404152" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
</span>
</button>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mx-auto mb-20 mb-lg-0 navbar-nav-scroll">
<li class="nav-item dropdown">
<div class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true aria-expanded=false>
About
</div>
<div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink>
<a class=dropdown-item href=/about/who-we-are/>Who We Are</a>
<a class=dropdown-item href=/about/members/>Members</a>
<a class=dropdown-item href=/about/governance/>Governance</a>
<a class=dropdown-item href=/about/faq/>FAQ</a>
<a class=dropdown-item href=/about/contact/>Contact</a>
</div>
</li>
<li class=nav-item>
<a class=nav-link href=/projects/>
Projects
</a>
</li>
<li class=nav-item>
<a class=nav-link href=/events/>
Events
</a>
</li>
<li class=nav-item>
<a class=nav-link href=/workgroups/>
Workgroups
</a>
</li>
<li class="nav-item dropdown">
<div class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true aria-expanded=false>
News
</div>
<div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink>
<a class=dropdown-item href=/categories/announcements/>Announcements</a>
<a class=dropdown-item href=/categories/blog/>Blog</a>
<a class=dropdown-item href=/categories/reports/>Reports</a>
</div>
</li>
<li class=nav-item>
<a class=nav-link href=/join/>
Join
</a>
</li>
</ul>
</div>
<div class="d-none d-lg-block">
<div class=nav-item>
<a href=/getting-started/ class="btn btn-sm btn-primary">Get Started</a>
</div>
</div>
</nav>
</header>
<section class=blog-details>
<div class=container>
<div class=row>
<div class=col-lg-12>
<article class=blog-single>
<div class=inner-blog-details>
<h1>Open Source USB test suite</h1>
<div class=inner-blog-details-meta>
<ul class=list-unstyled>
<li class=list-inline-item>
<p>December 6, 2019</p>
</li>
<li class=list-inline-item>
<p>5 <span>minutes</span></p>
</li>
<li class=list-inline-item>
<p>873 <span>words</span></p>
</li>
</ul>
</div>
</div>
<div class="rounded-box mb-xxl-11 mb-8">
<img src=https://chipsalliance.org/images/blog-share.jpg class=w-100 alt=featured-image>
</div>
<div><p><strong>Note</strong>: the open source test suite will be demonstrated at the CHIPS Alliance booth at the <a href=https://tmt.knect365.com/risc-v-summit/>RISC-V Summit 2019</a> – join us Dec 10-12 in the San Jose Convention Center!</p>
<p>USB is often a daunting topic for developers, and implementing support for it from scratch is a time consuming task. When the expected result is more complicated than a USB-to-serial bridge, the solution would be to either use a hardware transceiver or, especially for older USB standards, use an open source core to implement one directly in the FPGA fabric. But which core to use?</p>
<p>There are many different USB IP cores available, implemented in languages ranging from traditional HDLs like Verilog to modern alternatives like <a href=https://github.com/m-labs/migen>migen</a> (or its new variant, <a href=https://github.com/m-labs/nmigen>nmigen</a>). Most of them come with their own set of test cases, often checking their internal mechanisms and not corresponding directly to those in other projects. What was lacking is a unified test suite that would run each core through the same set of scenarios, providing a direct, apples-to-apples comparison of their behavior.</p>
<p>A solution from <a href=https://antmicro.com/>Antmicro</a>, a CHIPS Alliance Gold member, is an open source test suite for USB IP cores, available <a href=https://github.com/antmicro/usb-test-suite-build>on their Github</a>. It currently supports USB1.1 and will be extended for higher revisions in the future.</p>
<p>In the test suite, Antmicro is making use of several open source technologies that they have come to appreciate through other projects. The tests are implemented using <a href=https://github.com/cocotb/cocotb>Cocotb</a> and the low-level details are handled by the newly created <a href=https://github.com/antmicro/usb-test-suite-cocotb-usb>cocotb_usb</a> package. This means that even complicated tests, like those that verify the enumeration procedure under different OSes can be written with easy to understand, Python syntax.</p>
<pre tabindex=0><code>from cocotb_usb.harness import get_harness
from cocotb_usb.device import UsbDevice
from cocotb_usb.descriptors import Descriptor

@cocotb.test()
def test_enumeration(dut):
    harness = get_harness(dut)
    yield harness.reset()
    yield harness.connect()

    yield Timer(1e3, units=&quot;us&quot;)

    yield harness.port_reset(1e3)
    yield harness
          .get_device_descriptor(response=model
              .deviceDescriptor.get())

    yield harness.set_device_address(DEVICE_ADDRESS)
</code></pre><h2 id=test-suite-architecture>Test suite architecture</h2>
<p>As the various IP cores often provide different interfaces towards the user, from different kinds of FIFOs to expected signals to drive the bidirectional USB pins, they are wrapped in a unified layer to create a simple SoC, also written in Python using <a href=https://github.com/enjoy-digital/litex>LiteX</a>. It provides various helper blocks and takes care of the bus infrastructure, clocking and reset logic, generating Verilog output for the whole system ready to be tested under any number of open source simulators. A minimalistic testbench file provides a unified interface as the top object for the simulation.</p>
<p><img src=usb-test-diagram.svg alt="USB testing diagram"></p>
<h2 id=python-package>Python package</h2>
<p>At the heart of the test suite is <code>cocotb_usb</code>, a Python package providing API for sending and receiving various USB packets, handling low-level bus states, verifying descriptor contents and checking timings. This is done by providing a <code>UsbTest</code> object that acts as a host and interacts with the device under test. Depending on your needs, you can output single packets, use whole transactions with e.g. automated retries upon receiving “not acknowledged” tokens, or just use high-level functions like <code>get_config_descriptor()</code> and let the library handle all the details. Meanwhile, the <code>UsbDevice</code> class provides means to store all of the descriptors that the core can report in an organized way.</p>
<p>The test results can be viewed in a standard Cocotb XML results file, the behavior of all signals in the system at all points can be checked in a VCD signal dump (to be viewed e.g. in <a href=http://gtkwave.sourceforge.net/>GTKWave</a>) and we use open source <a href=https://sigrok.org/>sigrok</a> decoders to obtain packets and transactions, to be exported for viewing in Wireshark.</p>
<p><img src=tinyfpga_gtwave_wireshark.png alt="Test results in GTKWave"></p>
<h2 id=current-checks>Current checks</h2>
<p>Currently tested cores are:</p>
<ul>
<li><a href=https://github.com/im-tomu/valentyusb>ValentyUSB</a> – CPU-less IP core written in LiteX, using the eptri interface</li>
<li><a href=https://github.com/im-tomu/foboot>Foboot</a> – target with VexRiscv CPU running bare-metal Foboot firmware (it utilizes the epfifo interface of the ValentyUSB core)</li>
<li><a href=https://github.com/www-asics-ws/usb1_device>usb1_device</a> – a USB1.1 IP core developed by asics.ws in Verilog</li>
<li><a href=https://github.com/tinyfpga/TinyFPGA-Bootloader>TinyFPGA USB bootloader</a> – IP core written in Verilog with interesting features, like providing an interface to program SPI flash memory over USB</li>
<li><a href=https://github.com/smunaut/ice40-playground/tree/master/cores/usb>tnt`s USB IP core</a> – target with a PicoRV32 CPU, running bare-metal firmware interfacing with the Verilog IP core</li>
</ul>
<p>So, what tests are supported? They range from a simple control packet handling with both <a href=https://github.com/antmicro/usb-test-suite-testbenches/blob/master/tests/test-basic.py>single</a> and <a href=https://github.com/antmicro/usb-test-suite-testbenches/blob/master/tests/test-sequence.py>multiple transfers</a>, through <a href=https://github.com/antmicro/usb-test-suite-testbenches/blob/master/tests/test-sof.py>handling SOF packets</a>, validating <a href=https://github.com/antmicro/usb-test-suite-testbenches/blob/master/tests/test-clocks.py>clock recovery</a> in the presence of an imperfect clock signal, to complex enumeration scenarios under <a href=https://github.com/antmicro/usb-test-suite-testbenches/blob/master/tests/test-enum.py>Linux</a>, <a href=https://github.com/antmicro/usb-test-suite-testbenches/blob/master/tests/test-w10enum.py>Windows 10</a> and <a href=https://github.com/antmicro/usb-test-suite-testbenches/blob/master/tests/test-macOSenum.py>macOS</a>. There are also some special cases, like testing the ValentyUSB core <a href=https://github.com/antmicro/usb-test-suite-testbenches/blob/master/tests/test-eptri.py>without a CPU</a> by configuring it through a Wishbone bus, or verifying behavior of the TinyFPGA-Bootloader by <a href=https://github.com/antmicro/usb-test-suite-testbenches/blob/master/tests/test-cdc.py>using CDC transfers</a> to send a boot command to the core.</p>
<h2 id=contributing>Contributing</h2>
<p>While full blown documentation is coming soon, there are ways to get involved right now:</p>
<ul>
<li>First, to run the test suite, go to the <a href=https://github.com/antmicro/usb-test-suite-build>repository</a> and follow the steps in the README,</li>
<li>To write your own test, take a look at <a href=https://github.com/antmicro/usb-test-suite-testbenches/tree/master/tests>our tests folder</a> and the functions provided by the UsbTest class,</li>
<li>To run the tests on another IP core, you will need to prepare a simple LiteX wrapper, a config file with expected descriptor values that the core will return and a Makefile that will point to the needed files and provide the needed steps,</li>
<li>If you would like to test a different USB class that your target supports, head to the <a href=https://github.com/antmicro/usb-test-suite-cocotb-usb>cocotb_usb repository</a> and feel free to extend it with that class’ descriptors and requests.</li>
</ul>
</div>
</article>
</div>
</div>
</div>
</section>
<section class="blog-related position-relative">
<div class=container>
<div class=row>
<div class=col-md-12>
<div class=blog-section>
<h2 class=blog-section-title>Recent News</h2>
</div>
</div>
</div>
<div class=row>
<div class="col-lg-4 col-md-6">
<article class=blog-post>
<div class=blog-post-thumb>
<a href=/news/constrained-randomization-verilator/>
<img src=https://chipsalliance.org/news/constrained-randomization-verilator/Constrained-randomization-in-Verilator--blog-sm--CHIPS.png alt=blog-thumb loading=lazy>
</a>
</div>
<div class=blog-post-content>
<div class=blog-post-tag>
<a href=https://chipsalliance.org/categories/blog>Blog</a>
</div>
<div class=blog-post-date>
January 21, 2025
</div>
<div class=blog-post-title>
<a href=/news/constrained-randomization-verilator/>Constrained randomization in Verilator</a>
</div>
</div>
</article>
</div>
<div class="col-lg-4 col-md-6">
<article class=blog-post>
<div class=blog-post-thumb>
<a href=/news/caliptra-support-for-veer/>
<img src=https://chipsalliance.org/news/caliptra-support-for-veer/VeeR-EL2-Tock--blog-sm.png alt=blog-thumb loading=lazy>
</a>
</div>
<div class=blog-post-content>
<div class=blog-post-tag>
<a href=https://chipsalliance.org/categories/blog>Blog</a>
</div>
<div class=blog-post-date>
January 9, 2025
</div>
<div class=blog-post-title>
<a href=/news/caliptra-support-for-veer/>Caliptra - Support for VeeR EL2 with User Mode and Physical Memory Protection in Tock embedded OS</a>
</div>
</div>
</article>
</div>
<div class="col-lg-4 col-md-6">
<article class=blog-post>
<div class=blog-post-thumb>
<a href=/news/topwrap/>
<img src=https://chipsalliance.org/news/topwrap/topwrap--blog-sm-CHIPS.png alt=blog-thumb loading=lazy>
</a>
</div>
<div class=blog-post-content>
<div class=blog-post-tag>
<a href=https://chipsalliance.org/categories/blog>Blog</a>
</div>
<div class=blog-post-date>
December 20, 2024
</div>
<div class=blog-post-title>
<a href=/news/topwrap/>Topwrap – open source toolkit for modular, parameterizable digital logic design</a>
</div>
</div>
</article>
</div>
</div>
</div>
</section>
<footer class="footer pt-xxl-19 pt-8 pb-sm-7 pb-5" id=footer>
<div class=container-fluid>
<div class=footer-wrapper>
<div class=row>
<div class="col-12 col-lg-4 me-auto order-2 order-lg-1">
<div class="footer-logo mt-7 mt-md-0 mb-5">
<a href=/>
<img src=/images/chips-logo-white.svg alt=logo>
</a>
</div>
<div class=social-icon>
<ul class=list-unstyled>
<li>
<a href=https://twitter.com/chipsalliance> <i class=ph-twitter-logo></i> </a>
</li>
<li>
<a href=https://github.com/chipsalliance> <i class=ph-github-logo></i> </a>
</li>
<li>
<a href=https://www.linkedin.com/company/chipsalliance/> <i class=ph-linkedin-logo></i> </a>
</li>
</ul>
</div>
<div class="footer-logo mt-7 mt-md-0">
<p>
© Copyright <span>2025</span> CHIPS Alliance
The Linux Foundation® . All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href=https://www.linuxfoundation.org/trademark-usage>Trademark Usage</a> page. Linux is a registered trademark of Linus Torvalds. <a href=http://www.linuxfoundation.org/privacy>Privacy Policy</a> and <a href=http://www.linuxfoundation.org/terms>Terms of Use</a>.
</p>
</div>
</div>
<div class="col-6 col-md-4 col-sm-4 col-lg-2 order-1">
<div class=footer-widget>
<h3>About</h3>
<ul class=list-unstyled>
<li>
<a href=/about/who-we-are/>Who We Are</a>
</li>
<li>
<a href=/about/members/>Members</a>
</li>
<li>
<a href=https://members.chipsalliance.org/>Member Support</a>
</li>
<li>
<a href=/about/governance/>Governance</a>
</li>
<li>
<a href=/about/faq/>FAQ</a>
</li>
<li>
<a href=/about/contact/>Contact</a>
</li>
</ul>
</div>
</div>
<div class="col-6 col-md-4 col-sm-4 col-lg-2 order-1">
<div class=footer-widget>
<h3>Community</h3>
<ul class=list-unstyled>
<li>
<a href=/projects/>Projects</a>
</li>
<li>
<a href=/getting-started/>Getting Started</a>
</li>
<li>
<a href=/events/>Events</a>
</li>
<li>
<a href=/workgroups/>Workgroups</a>
</li>
</ul>
</div>
</div>
<div class="col-6 col-md-4 col-sm-4 col-lg-2 order-1">
<div class=footer-widget>
<h3>News</h3>
<ul class=list-unstyled>
<li>
<a href=/categories/announcements/>Announcements</a>
</li>
<li>
<a href=/categories/blog/>Blog</a>
</li>
<li>
<a href=/categories/reports/>Reports</a>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</footer>
<script src=/vendor/jQuery/jquery.min.js></script>
<script src=/vendor/bootstrap/bootstrap.bundle.min.js></script>
<script src=/vendor/counter-up/countup.js></script>
<script src=/vendor/magnific-popup/magnific-popup.min.js></script>
<script src=/js/script.js></script>
</body>
</html>